<!DOCTYPE html>
<html>

<head>
    <title>Math And Color</title>
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

</head>
<style type="text/css">
/**
TODO: move css to a separate file
TODO: my requirement for css;

For any device/browser size smaller than 1000 px(A4), display as 1 column.
Anything larger than 1000 px, display side by side.

Ideal device is having display resolution of 1200 px.

Kids have to print and do math on the image..so any device smaller than A4, 
is not ideal way to use this app.

This does NOT stop the user to minimize the view and increase the font size
of fields.

**/
    body{ background-color: ivory; padding:20px;}
    #wrapper{
        position:relative;
        width:1000px;
        height:1000px;
    }
    #bkImage{
        position:absolute; 
        top:0px; 
        width:100%;
        height:100%;
    }
    #myCanvas{
        position:absolute; 
        top:0px; 
        left:0px;
        border:1px solid black;
        width:100%;
        height:100%;
        text-align:center;
    }
    h1 {
       text-align:center;
    }
    label {
      width: 100px;
      padding-right: 20px;
      display: inline-block;
    }
    /**
    http://css-plus.com/2010/11/how-to-horizontally-centre-anything-with-css/
    What this does is, it causes the whole thing to be centere aligned.
    However the field set does not re-align one below the other, if the
    page is re-sized.

    My requirement is for the image to be viewed at its best, so this is ok to me.
    If i resize and the x,y a,b becomes visible, still you cannot see the image 
    and all its text.
    **/
    .container{
        display: table; 
        margin: 0 auto;
        font-size: 150%;
    }
    /**
    http://stackoverflow.com/questions/12710799/two-fieldsets-with-display-inline-aligning-on-bottom
    **/
</style>
<body>

<div class="container">
    <h1>Learn And Color</h1>
    <div class="form-group"  id="inputsId">
        <fieldset class="fieldSet1">
            <label for="textCoordinateId">Text Coordinate#:</label>
            <input class="form-control" type="name" id="textCoordinateId" placeholder="-1 or 1,2"/>
            <br/>
            <label for="xId">X:</label>
            <input class="form-control" type="name" id="xId" placeholder="X"/>
            <br/>
            <label for="yId">Y:</label>
            <input class="form-control" type="name" id="yId" placeholder="Y"/>
            <br/>
            <label for="fontSizeId">Font Size:</label>
            <input class="form-control" type="name" id="fontSizeId" value="40"/>
        </fieldset>

        <fieldset>
            <label for="numberAId">A:</label>
            <input class="form-control" type="name" id="numberAId" placeholder="Enter Number A"/>
            <br/>
            <label for="operatorId">Operator:</label>
            <input class="form-control" type="name" id="operatorId" placeholder="Operator"/>
            <br/>
            <label for="numberBId">B:</label>
            <input class="form-control" type="name" id="numberBId" placeholder="Enter Number B"/>
        </fieldset>
        <fieldset>
            <button class="form-control" id="doneId" onclick="addText()">Add Number To Image</button>
            <br/>
            <button class="form-control" id="hideId" onclick="hideInputs()">Hide Inputs</button>
            <br/>
            <button class="form-control" id="configurationId" onclick="toggleAdvanced()">Advanced</button>
        </fieldset>
        <fieldset>
            <button class="form-control" id="showOtherImagesId" onclick="showOtherImages()">Show Other Images</button>
            <br/>
            <button class="form-control" id="prefillImageId" onclick="prefillImage()">Prefill Image With Text</button>
            <input id="image_from_list" name="image_from_list" type="text" value="red"  />
            <img src="images/butterfly.jpg" col="red" border="0" width="50 px" height="50 px" 
            />
            <img src="images/puppy.gif" col="blue" border="0" width="50 px" height="50 px"
            />
            <img src="images/teddyBear.jpg" col="yellow" border="0" width="50 px" height="50 px"
            />
        </fieldset>
        <br/>
    </div>
    <!--http://stackoverflow.com/questions/12886286/addeventlistener-for-keydown-on-canvas
    Added tab index, to make canvas focusable. Unlike other html elements, it is NOT
    focusable by default.
    -->

    <!--<canvas id="myCanvas" width="1000" height="1000" style="border:1px solid #d3d3d3;" tabindex="1" 
    onclick="mouseMoveHandler(this,event)">
        Your browser does not support the HTML5 canvas tag.
    </canvas>-->

    <div id="wrapper" class="formgroup">
        <!--
        http://stackoverflow.com/questions/18431332/delete-only-text-but-not-the-image-using-canvas
        http://jsfiddle.net/m1erickson/fg5sV/
        INFO: both canvas and image overlap.Only the text goes on to the canvas.
        -->
        <img id="bkImage" src="dora-the-explorer-coloring-pages-pdf-coloring-pages-printable-coloring-pages-pdf.gif"
         width=1000 height=1000></canvas>
        <canvas id="myCanvas" width=1000 height=1000 tabindex="1" 
    onclick="mouseMoveHandler(this,event)">
        Your browser does not support the HTML5 canvas tag.
        </canvas>
    </div>

    <div>
        You can use this space to display (x,y) coordinates,and its text
    </div>

    </div>
    <script type="text/javascript">

        var FONT_SIZE = $('#fontSizeId').val();
        var mousePos;
        var textCoordinateHistory=[];


        window.onload = function() {
            draw();
            toggleAdvanced();
        };
        //INFO: outside of onload

        $("div#inputsId img").click(function () {
            $("div#inputsId img").attr("border","0");
            $(this).attr("border","4");
            $("input#image_from_list").val($(this).attr("col"));
        }); 

        function toggleAdvanced(){
            $(".fieldSet1").toggle(); 
        }

        function addToHistory(textCoordinate){
            textCoordinate.setId(Number(textCoordinateHistory.length+1));
            textCoordinateHistory.push(textCoordinate);
        }

        function erase(canvas) {
            var context = canvas.getContext("2d");
            context.clearRect(0, 0, canvas.width, canvas.height);
        }
        function draw() {
            var canvas = document.getElementById("myCanvas");
            var context = canvas.getContext("2d");
            context.font = FONT_SIZE+"pt Calibri";
            context.fillText("Name:", 30, FONT_SIZE);
            //Fill your name
            context.fillText("__________", 30, (3*Number(FONT_SIZE)));
            context.fillText("_______", 30, (5*Number(FONT_SIZE)));
        }

        //INFO: capture the last position of mouse, by mouse listener.
        //on key down, write to the last known position of the mouse.

        function mouseMoveHandler(canvas, event) {
            showInputs();
            mousePos = getMousePos(canvas, event);
            $("#xId").val(mousePos.x);
            $("#yId").val(mousePos.y);
            $("#numberAId").focus();
            $("#textCoordinateId").val("-1");
        }
        /**
        http://www.html5canvastutorials.com/advanced/html5-canvas-mouse-coordinates/
        **/
        function getMousePos(canvas, evt) {
            var rect = canvas.getBoundingClientRect();
            var x = Math.round(evt.clientX - rect.left);
            var y = Math.round(evt.clientY - rect.top);
            return {
                x: x,
                y: y
            };
        }

        //INFO:Class TextCoordinate, group text starting at a particular coordinate.
        //Say, starting at x,y display 33+40=__. 
        //Functions:
        //1. Any time it exceeds coordinates of canvas re-adjust.
        //2. Any time this falls with in range of another co-ordinate,
        //do not return the instance.
        //3. Given x,y , calculate appropriately for A,B,operator and ___ text.

        function TextCoordinate (x, y, a,b,operator) {
            this.x = x;
            this.y = y;
            this.a = a;
            this.b = b;
            this.operator = operator;
            this.id=-1;
            this.setId=function(id){
                this.id=id;
            }
            this.adjust = function (canvas) {
                console.log("adjust");
                //INFO: Calculate space taken by 40 px character.
                var delta =  Number(Number(FONT_SIZE)*(Math.max(a.length,b.length)));
                //left, top, right, bottom, x, y, width, height
                var canvasBounds = canvas.getBoundingClientRect();
                console.log("canvasBounds.x:"+canvasBounds.x);
                console.log("canvasBounds.left:"+canvasBounds.left);
                console.log("canvasBounds.right:"+canvasBounds.right);
                console.log("Number(x):"+Number(x));
                console.log("delta: "+FONT_SIZE+"*(Math.max(a.length,b.length)):"
                    +delta);
                console.log("canvasBounds.top:"+canvasBounds.top);
                console.log("canvasBounds.bottom:"+canvasBounds.bottom);
                console.log("canvasBounds.y:"+canvasBounds.y);
                console.log("Number(y):"+Number(y));

                //INFO: align to right margin.
                if( (Number(x)+Number(delta)+canvasBounds.left)  > canvasBounds.right) {
                    console.log("readjusted x for right bounds from x :"+x);
                    this.x = Math.round(Number(canvasBounds.right) - Number(delta) - canvasBounds.left);
                    console.log("to :"+this.x);
                }
                //INFO: align for the one -/+/* character
                if( (Number(x)+canvasBounds.left-Number(FONT_SIZE))  < canvasBounds.left) {
                    console.log("readjusted x for left bounds from x :"+x);
                    this.x = Number(FONT_SIZE);
                    console.log("to :"+this.x);
                }
                //INFO:Basically adjusting for
                // 32
                //+44
                //=76
                //3 font sizes,3*40=120
                console.log("( Number(y) + Number(canvasBounds.top) + (3*Number(FONT_SIZE)) ) > canvasBounds.bottom");
                console.log(( Number(y) + Number(canvasBounds.top) + (3*Number(FONT_SIZE)) ) + " > " + canvasBounds.bottom);
                if( ( Number(y) + Number(canvasBounds.top) + (3*Number(FONT_SIZE)) ) > canvasBounds.bottom) {
                    console.log("readjusted y for bottom from y :"+y);
                    this.y = canvasBounds.bottom - Number(canvasBounds.top) - (3*Number(FONT_SIZE));
                    console.log("to :"+this.y);
                }
                //INFO: the numbers are starting somewhere in the middle, so ensuring 1 font size gap at top
                console.log("( Number(y) + Number(canvasBounds.top) - Number(FONT_SIZE) ) < canvasBounds.top");
                console.log( ( Number(y) + Number(canvasBounds.top) - Number(FONT_SIZE) ) + " < " + canvasBounds.top);
                if( ( Number(y) + Number(canvasBounds.top) - Number(FONT_SIZE) ) < canvasBounds.top) {
                    console.log("readjusted y for top from y :"+y);
                    this.y = canvasBounds.top - Number(canvasBounds.top) + Number(FONT_SIZE);
                    console.log("to :"+this.y);
                }
            }

            this.getBCoordinate = function(){
                console.log("Number(FONT_SIZE)"+Number(FONT_SIZE));
                return {
                    x: this.x,
                    y: (Number(this.y) + Number(FONT_SIZE))
                };
            }
            this.getLineLength = function() {
                var lineLength = Math.max(a.length,b.length);
                console.log("Line Length:"+lineLength);
                return lineLength;
            }
            this.getLine = function() {
                //TODO: Note, you may have to bind "this" to correct object instance.
                //to avoid confusion with in js.
                var lineLength = this.getLineLength();
                var line="";
                while(lineLength > 0) {
                    line = line + "_";
                    lineLength = lineLength - 1;
                }
                return line;   
            }
            this.getLine1Coordinate = function(){
                console.log("Number(FONT_SIZE)"+Number(FONT_SIZE));
                return {
                    x: this.x,
                    y: (Number(this.y) + (Number(1.25)*Number(FONT_SIZE)))
                };
            }
            this.getLine2Coordinate = function(){
                console.log("Number(FONT_SIZE)"+Number(FONT_SIZE));
                return {
                    x: this.x,
                    y: (Number(this.y) + (Number(2.5)*Number(FONT_SIZE)))
                };
            }
            this.getOperatorCoordinate = function() {
                var x1 = Number(this.x)-Math.round(Number(FONT_SIZE)/2);
                var y1 = Number(this.y)+Math.round(Number(FONT_SIZE)/2);
                return {
                    x:x1,
                    y:y1
                }
            }
            this.getMinX=function(padding){
                var minX=Math.round(Number(this.x) + Number(padding));
                console.log("Math.round(Number(this.x) - Number(padding))");
                console.log("Math.round("+
                    Number(this.x) +"-"+ Number(padding)  +
                    ")");
                console.log("Math.round("+
                    ( Number(this.x) - Number(padding) ) +
                    ")");
                return Math.round(Number(this.x) - Number(padding));
            }
            this.getMaxX=function(padding){
                var lineLength = Number(FONT_SIZE)*Number(this.getLineLength());
                return Math.round(Number(this.x) + Number(padding) + Number(lineLength));                
            }
            this.getMinY=function(padding){
                return Math.round(Number(this.y) - Number(padding));
            }
            this.getMaxY=function(padding){
                var verticalHeight = Number(FONT_SIZE)*Number(3.5);
                return Math.round(Number(this.y) + Number(padding) + Number(verticalHeight));                
            }            
            this.isWithinLimits = function(textCoordinate) {
                console.log("checking");
                var minX = this.getMinX(Math.round(Number(FONT_SIZE)/2));
                var minY = this.getMinY(Math.round(Number(FONT_SIZE)/2));
                var maxX = this.getMaxX(Math.round(Number(FONT_SIZE)/2));
                var maxY = this.getMaxY(Math.round(Number(FONT_SIZE)/2));
                var withinLimits=false;
                if( 
                    ( minX <= textCoordinate.x )
                 && ( maxX >= textCoordinate.x ) 
                 ) {
                console.log("(x) Falls with in x coordinates (x1) and (x2)");
                console.log("("+textCoordinate.x
                    +") Falls with in x coordinates ("+minX
                    +") and ("+maxX
                    +")");
                    withinLimits=true;
                }
                if( 
                    ( withinLimits && minY <= textCoordinate.y )
                 && ( maxY >= textCoordinate.y)
                 ) {
                    console.log("(y) Falls with in x coordinates (y1) and (y2)");
                    console.log("("+textCoordinate.y
                        +") Falls with in y coordinates ("+minY
                        +") and ("+maxY
                        +")");
                }else{
                    withinLimits=false;                    
                }
                if(withinLimits) {
                    console.log("(x,y) Falls with in x coordinates (x1,y1) and (x2,y2)");
                    console.log("("+textCoordinate.x+","+textCoordinate.y+") Falls with in ("+minX+","+
                        minY+") and ("+maxX+","+maxY+")");
                }
                return withinLimits;
            }
            this.printValue= function() {
                return "id="+this.id+" ("+x+","+ y+") : "+a+operator+b+"=?";
            }            
        }

        //INFO:Instead of adding it on load, if we add it as event based on canvas element,
        //then it can be re-used across pages.
        //Later this can also be made data driven.
        //canvas.addEventListener("keyup", keyUpHandler, true);
        //canvas.addEventListener('mousemove',mouseMoveHandler,true);

        function addletter(canvas, letter, x, y) {
            var context = canvas.getContext("2d");
            //keyHistory += letter;
            //INFO: clears a lot of area so commented.
            //context.clearRect(x, y, x+20, y+50);
            context.fillText(letter, x, y );
        }

        function addLetterToA(canvas,textCoordinate) {
            console.log("Adding letter to A");
            console.log("canvassing...");
            console.log("adding...(x,y)=("+textCoordinate.x+","+textCoordinate.y+")");
            addletter(canvas, textCoordinate.a, textCoordinate.x, textCoordinate.y);
            console.log("added...");
        }
        function addLetterToB(canvas,textCoordinate) {
            console.log("Adding letter to B");
            console.log("canvassing...");
            var bCoordinate=textCoordinate.getBCoordinate();
            console.log("adding...(x,y)=("+bCoordinate.x+","+bCoordinate.y+")");
            //INFO: write in next line.
            addletter(canvas, textCoordinate.b, bCoordinate.x, bCoordinate.y);
            console.log("added...");            
        }
        function addLine1(canvas,textCoordinate) {
            console.log("Adding line1");
            console.log("canvassing...");
            var line1Coordinate=textCoordinate.getLine1Coordinate();
            console.log("adding...(x,y)=("+line1Coordinate.x+","+line1Coordinate.y+")");
            var line=textCoordinate.getLine();
            //INFO: write in next line.
            addletter(canvas, line, line1Coordinate.x, line1Coordinate.y);
            console.log("added...");            
        }       
        function addLine2(canvas,textCoordinate) {
            console.log("Adding line2");
            console.log("canvassing...");
            var line2Coordinate=textCoordinate.getLine2Coordinate();
            console.log("adding...(x,y)=("+line2Coordinate.x+","+line2Coordinate.y+")");
            //INFO: write in next line.
            var line=textCoordinate.getLine();
            addletter(canvas, line, line2Coordinate.x, line2Coordinate.y);
            console.log("added...");            
        }           
        function addLetterToOperator(canvas,operator,textCoordinate){
            //TODO: refactor this function.
            console.log("Adding letter to Operator");
            console.log("canvassing...");
            var operatorCoordinate = textCoordinate.getOperatorCoordinate();
            console.log("adding...(x1,y1)=("+operatorCoordinate.x+","+operatorCoordinate.y+")");
            //INFO: write it between 2 numbers, slightly to left
            addletter(canvas, operator, operatorCoordinate.x, operatorCoordinate.y);
            console.log("added...");
        }
        function addText() {
            var x=$('#xId').val();
            var y=$('#yId').val();
            var letterA = $('#numberAId').val();
            var letterB = $('#numberBId').val();
            var operator = $('#operatorId').val();
            var canvas = document.getElementById("myCanvas");
            var textCoordinateId=$('#textCoordinateId').val();
            var textCoordinateWithinLimits;
            //INFO: Editing existing coordinate.
            var currentTextCoordinate;

            var textCoordinate = new TextCoordinate(x,y,letterA,letterB,operator);
            textCoordinate.adjust(canvas);

            if(textCoordinateId>0) {
                console.log("Editing textCoordinateId"+textCoordinateId);
                textCoordinate.setId(textCoordinateId);
                textCoordinateHistory[textCoordinateId-1]=textCoordinate;
                //TODO: redraw.
                console.log("Redrawing");
                erase(canvas);
                draw();
                console.log("total:"+textCoordinateHistory.length);
                for (var j = 0; j < textCoordinateHistory.length; j++){
                    currentTextCoordinate = textCoordinateHistory[j];
                    console.log("currentTextCoordinate:"+currentTextCoordinate.printValue());
                    addLetterToA(canvas,currentTextCoordinate);
                    addLetterToOperator(canvas,operator,currentTextCoordinate);
                    addLetterToB(canvas,currentTextCoordinate);
                    addLine1(canvas,currentTextCoordinate);
                    addLine2(canvas,currentTextCoordinate);
                }
                //INFO: End of editing existing coordinate.
            }else{
                var withinLimits = false;
                //INFO: adding a new coordinate.
                //INFO: End adding a new coordinate.
                for (var j = 0; j < textCoordinateHistory.length; j++){
                    console.log("Checking "
                     + textCoordinateHistory[j].printValue() +" with "+ textCoordinate.printValue());
                    //TODO: do whether the clicked coordinates are with in limits, on click, instead of
                    //doing it on click of "Done" button
                    withinLimits = textCoordinateHistory[j].isWithinLimits(textCoordinate);
                    if(withinLimits) {
                        console.log("With in limits:" + withinLimits);
                        textCoordinateWithinLimits = textCoordinateHistory[j];
                        j = textCoordinateHistory.length;
                    }
                }
                if(!withinLimits) {
                    console.log("Adding new values");
                    x=textCoordinate.x;
                    y=textCoordinate.y;
                    $('#xId').val(x);
                    $('#yId').val(y);            
                    addLetterToA(canvas,textCoordinate);
                    addLetterToOperator(canvas,operator,textCoordinate);
                    addLetterToB(canvas,textCoordinate);
                    addLine1(canvas,textCoordinate);
                    addLine2(canvas,textCoordinate);
                    var x1= Number(x) - Number(10);
                    var y1=Number(y) - Number(10);
                    addToHistory(textCoordinate);
                    console.log("total"+textCoordinateHistory.length);                
                }else {
                    console.log("New value is existing value, so Populating existing values");
                    //INFO: populate x,y a,b,operator and TODO: id.
                    $('#xId').val(textCoordinateWithinLimits.x);
                    $('#yId').val(textCoordinateWithinLimits.y);            
                    $('#numberAId').val(textCoordinateWithinLimits.a);
                    $('#numberBId').val(textCoordinateWithinLimits.b);
                    $('#operatorId').val(textCoordinateWithinLimits.operator);
                    $('#textCoordinateId').val(textCoordinateWithinLimits.id);
                }
            }
        }
        function showInputs() {
            $("#inputsId").show();
        }
        function hideInputs() {
            $("#inputsId").hide();
        }
    </script>

</body>

</html>